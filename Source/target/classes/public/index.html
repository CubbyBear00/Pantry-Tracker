<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pantry Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif;  max-width: 800px; margin: auto; padding: 20px; background: #21214f; color:white;}
        .card { background: rgb(94, 86, 255); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2, h3 {color: white; border-bottom: 2px solid #007bff; padding-bottom: 10px;}
        #reader { width: 100%; border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid rgb(126, 126, 126); text-align: left; }
        input {background: lightgray; border: 1px solid lightgray; color: black; padding: 8px; border-radius: 4px;}
        .btn { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: rgb(255, 255, 255); }
        .btn-scan { background: #28a745; margin-bottom: 10px; width: 100%; font-size: 1.1em; }
    </style>
</head>
<body>

    <h1>Barcode Pantry Tracker</h1>

    <div class="card">
        <button class="btn btn-scan" onclick="startScanner()">Open Camera Scanner</button>
        <div id="reader"></div>
        <p id="status" style="text-align: center; color: #616161;"></p>
    </div>

    <div class="card">
        <h3>Add Item Manually</h3>
        <input type="text" id="mBarcode" placeholder="Barcode">
        <input type="text" id="mName" placeholder="Name">
        <input type="text" id="mBrand" placeholder="Brand">
        <input type="number" id="mQty" value="1" style="width: 50px;">
        <button class="btn" onclick="manualAdd()">Add Item</button>
    </div>

    <div class="card">
        <h3>Current Inventory</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Brand</th>
                    <th>Qty</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                </tbody>
        </table>
    </div>

    <script>
        let html5QrcodeScanner;

        // --- SCANNER LOGIC ---
        function startScanner() {
            document.getElementById('status').innerText = "Scanning for barcodes...";
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 30, 
                    qrbox: { width: 250, height: 150 }, 
                    aspectRatio: 1.0 
                }
            );
            
            html5QrcodeScanner.render(onScanSuccess, () => {/* ignore failures */});
        }

        function onScanSuccess(decodedText) {
            html5QrcodeScanner.clear();
            document.getElementById('status').innerText = "Processing " + decodedText + "...";

            fetch(`/api/add?barcode=${decodedText}&qty=1`, { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        location.reload(); 
                    } else {
                        alert("Not found. Restarting scanner...");
                        startScanner();
                    }
                });
        }

        // --- INVENTORY LOGIC ---
        function loadInventory() {
            fetch('/api/inventory')
                .then(res => res.json())
                .then(data => {
                    const body = document.getElementById('inventoryBody');
                    body.innerHTML = data.map(item => `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.brand}</td>
                            <td>
                                <button onclick="updateQty('${item.barcode}', -1)">-</button>
                                <strong>${item.quantity}</strong>
                                <button onclick="updateQty('${item.barcode}', 1)">+</button>
                            </td>
                            <td>
                                <button onclick="deleteItem('${item.barcode}')" style="color:white; background:darkred;">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                });
        }

        function manualAdd() {
            const params = new URLSearchParams({
                barcode: document.getElementById('mBarcode').value,
                name: document.getElementById('mName').value,
                brand: document.getElementById('mBrand').value,
                qty: document.getElementById('mQty').value
            });
            fetch('/api/manual?' + params, { method: 'POST' }).then(() => location.reload());
        }

        function updateQty(barcode, change) {
            fetch(`/api/update?barcode=${barcode}&change=${change}`, { method: 'POST' }).then(() => loadInventory());
        }

        function deleteItem(barcode) {
            if(confirm("Delete this item?")) {
                fetch(`/api/delete?barcode=${barcode}`, { method: 'DELETE' }).then(() => loadInventory());
            }
        }

        // Load list on start
        loadInventory();
    </script>
</body>

<footer style="margin-top: 20px; padding: 10px; border-top: 1px solid #ccc; font-size: 0.8em;">
    <p>
        Data provided by 
        <a href="https://world.openfoodfacts.org/" target="_blank">Open Food Facts</a> 
        under the 
        <a href="https://opendatacommons.org/licenses/odbl/1-0/" target="_blank">ODbL License</a>.
    </p>
</footer>

</html>